name: ci

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  PYTHON_VERSION: "3.12.4"
  NODE_VERSION: "18.16.0"

  INTEGRATION_DIR: "IntegrationTests/Tests"
  INTEGRATION_COMPOSE: "docker-compose.integration.yml"
  UI_DIR: "UI"

  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"
  BUILDKIT_PROGRESS: "plain"

jobs:
  changes:
    name: changes
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      media: ${{ steps.filter.outputs.media }}
      chunker: ${{ steps.filter.outputs.chunker }}
      content: ${{ steps.filter.outputs.content }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'AuthService/**'
              - '.github/workflows/**'
            media:
              - 'MediaService/**'
              - '.github/workflows/**'
            chunker:
              - 'ChunkerService/**'
              - '.github/workflows/**'
            content:
              - 'ContentService/**'
              - '.github/workflows/**'
            ui:
              - 'UI/**'
              - '.github/workflows/**'

  publish-images:
    name: publish-images
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect root compose file
        id: compose
        run: |
          set -euo pipefail
          for f in compose.yaml compose.yml docker-compose.yml docker-compose.yaml; do
            if [ -f "$f" ]; then
              echo "file=$f" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done
          echo "No compose file found in repo root." >&2
          exit 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & push integration images
        working-directory: ${{ env.INTEGRATION_DIR }}
        run: |
          set -euo pipefail
          docker compose -f "${INTEGRATION_COMPOSE}" build
          docker compose -f "${INTEGRATION_COMPOSE}" push

      - name: Build & push e2e images
        run: |
          set -euo pipefail
          docker compose -f "${{ steps.compose.outputs.file }}" build
          docker compose -f "${{ steps.compose.outputs.file }}" push
